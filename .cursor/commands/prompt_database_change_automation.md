# データベース変更フロー自動化用プロンプト（テンプレート）

本テンプレートは、今後「データベースの追加・変更」要望が入力された際に、仕様確認 → 実装 → テスト → ドキュメント反映 → ログ記載までを一貫して実行するためのプロンプトです。Windows/uv/SQLite3 前提、日本語運用を想定しています。

---

## 使い方
1. 下記の「実行プロンプト」をそのまま貼り付け、`{{...}}` のプレースホルダーを埋めて実行してください。
2. ブラウザ動作が絡むテストが必要な場合は、実行前にユーザー確認を取り、playwright-mcp を使用してください。
3. すべての作業ログは `log.md` に日付入りで追記します。

---

## 実行プロンプト（コピペ用）
```
あなたはCursor上で動作する日本語対応の開発支援エージェントです。以下の環境・ルールで、入力されたデータベース変更要件を、非破壊的な移行・ドキュメント反映・API実装・テスト・ログ記録まで一気通貫で実施してください。

【環境/前提】
- OS/端末: Windows。パスは `database.db` からの相対パスで保存。
- DB: SQLite3（PRAGMA foreign_keys = ON を各接続ごとに有効化）。
- パッケージ/実行: uv（仮想環境は `.venv`）。
- プロジェクト標準: 日本語、丁寧なコメント、第三者が理解できるコード。
- ログ: 変更作業は都度 `log.md` に日付付きで追記。
- ブラウザが必要なテストは playwright-mcp 使用前にユーザーに確認。
- 既存データを破壊しない（CREATE IF NOT EXISTS, ガード付き ALTER, マイグレーションで安全に）。

【入力（必須）】
- 変更要件: {{DB_CHANGE_SPEC}}
  例）テーブル追加/列追加/制約/インデックス/参照関係/保存パス仕様 など

【アウトプット（達成基準）】
1. 質問事項の整理と `00_design/質問リスト.md` の更新（回答待ち/回答反映）。
2. 仕様書更新：`00_design/ref_design_byGrok4_2.md`（ER図・テーブル詳細・関係性・SQL例）。
3. スキーマ更新：`00_design/schema.sql`（CREATE IF NOT EXISTS / 必要に応じて CHECK 制約）。
4. 非破壊マイグレーション：`scripts/migrate_*.py` を追加/更新（存在確認 → 不足のみ作成/変更）。
5. API仕様更新：`00_design/api_specification.md`・`00_design/api_library_documentation.md`。
6. API実装：`datawarehouse/*_api.py` 追加/更新、`datawarehouse/__init__.py` 公開。
7. 動作確認：uv でマイグレーション → 簡易テスト（必要ならサンプルスクリプト作成・実行）。
8. ログ追記：`log.md` に日付付きで「仕様変更/スキーマ/マイグレーション/API/テスト結果」を記録。

【進め方（必須ステップ）】
- Step 0: TODO を作成（仕様確認 → 設計反映 → スキーマ → マイグレーション → API仕様 → 実装 → テスト → ログ）。
- Step 1: 既存ドキュメント/スキーマを読み込み、変更差分の影響範囲を推定。
- Step 2: 不明点を `00_design/質問リスト.md` に追記（YES/NO/選択肢形式、将来拡張も考慮）。
- Step 3: 回答が与えられ次第、ER図・テーブル詳細・関係性・SQL例を仕様書へ反映。
- Step 4: `00_design/schema.sql` を更新（CREATE IF NOT EXISTS/既存整合性維持、必要なら CHECK）。
- Step 5: 非破壊マイグレーション `scripts/migrate_*.py` を作成。存在確認 → 不足テーブル/列/制約のみ追加。
- Step 6: API仕様を更新（CRUD/検索/集計、パスは相対、FK の参照先明記）。
- Step 7: API実装を追加/更新（例外・検証・FK制約エラー取り扱い・Row→dict 変換）。`__init__.py` に公開。
- Step 8: uv でマイグレーション実行 → 簡易テスト実行。ブラウザ要件があれば事前確認の上 playwright-mcp で実施。
- Step 9: `log.md` に日付で経緯・影響範囲・結果を記載（仕様/スキーマ/マイグレーション/API/テスト）。

【実装ポリシー】
- 参照整合性: ON DELETE RESTRICT などデフォルト安全側。自己参照は SET NULL を検討。
- 互換性: 既存データに影響しないスクリプト（CREATE IF NOT EXISTS / ガード付き ALTER / 存在確認）。
- 検証: 値域（例: 0.0–1.0）、件数整合性（例: A<=B）、相対パスの取り扱い。
- 例外: DWH 系カスタム例外で明確化（Constraint/Validation/NotFound/Connection など）。
- コメント: 過不足なく、なぜ(Why)を中心に。

【注意】
- Windows 端末、SQLite、uv 前提でコマンド例を提示。
- `.gitignore` は既存方針に従い不要変更は避ける。
- playwright 系テストは事前確認を取り、可能なら自動化。

【今回の変更要件を適用開始】
- 変更要件: {{DB_CHANGE_SPEC}}
- まずは質問事項を抽出 → `00_design/質問リスト.md` へ追記し、未確定点を明示してください。
```

---

## 備考
- 本テンプレートは、非破壊的な移行（マイグレーション）を強制し、既存データ保護を優先します。
- 仕様変更の反映は常にドキュメント（ER図/SQL例/仕様書）→ スキーマ → 実装 → テスト → ログの順で行います。
- テストスクリプトはコミット前に削除するか、`tests/` 配下へ正式化してください。
